---
output:
  html_document: default
---

```{=html}
<style>
    h1 {
        font-family: "Times New Roman";
    }
    
    h1.title {
      font-weight: bold;
    }
    
    h2 {
        font-family: "Times New Roman";
    }
    
    h3 {
        font-family: "Times New Roman";
    }
    
    p {
        font-family: "Times New Roman";
        font-size: 14px;
    }
</style>
```

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) # Prevent overwhelming messages from reaching user

# Load libraries
library(RODBC)
library(knitr)
library(ggplot2)
library(sp)
library(sf)

```

```{r echo=FALSE}

# Set up report parameters here
SurveyYear = 2023  # Set this to the desired report year

# ODBC connection to the BAEA monitoring SQL Server Database. Set this up using 'ODBC Data Sources 64bit' on your computer.
# Contact data manager for server and database details.
# ConnectionString to the bald eagles Sql Server database
BaldEaglesConnectionString = "Driver=SQL Server Native Client 11.0;Server=inpyugamsvm01\\nuna;Database=CAKN_BaldEagles;trusted_connection=YES"

# Database connection to the eagles database
BaldEaglesConnection = odbcDriverConnect(connection = BaldEaglesConnectionString)

# Set the path to shapefiles used in the map, AK, Parks, Rivers, etc
ShpPath = "C:/Work/GIS Common Layers/"


```

---
title: Annual Report on Vital Signs monitoring of distribution and abundance of Bald Eagles in Wrangell-St. Elias National Park and Preserve, `r SurveyYear` 
output:
  html_document:

---


```{r echo=FALSE}

# Current date
CurrentDate = Sys.Date() # Get the current date


# Function to return data frames from SQL database queries
GetDataFrameFromDatabase <- function(Sql) {
   return(sqlQuery(BaldEaglesConnection, Sql))
}

# Function to convert a date string to a long date
GetLongDate <- function(Date) {
  return(format(as.Date(Date), format="%B %d, %Y "))
}

# These counters are used to number the tables and figures. Each gets incremented after use.
TableCounter = 1
FigureCounter = 1
```

Kyle Cutting^1^ and Scott Miller^2^

^1^National Park Service Wrangell St. Elias National Park and Preserve Copper Center, Alaska

^2^Arctic Inventory and Monitoring Network 240 W. 5th Ave Anchorage, Alaska 99501

`r CurrentDate`

U.S. Department of the Interior

National Park Service

Natural Resource Stewardship and Science

Fort Collins, Colorado

# Executive summary

Key Words: Wrangell-St. Elias National Park and Preserve, Bald Eagle, Haliaeetus leucocephalus, Population dynamics, monitoring, `r SurveyYear`

```{r echo=FALSE}
# Gather info to present in the text below

# Get the dates of the occupancy surveys
Sql = paste("SELECT  [Year]
      ,[MinOccupancySurveyDate]
      ,[MaxOccupancySurveyDate]
      ,[NumberOfOccupancySurveyDays]
      ,[MinProductivitySurveyDate]
      ,[MaxProductivitySurveyDate]
      ,[NumberOfProductivitySurveyDays]
  FROM [CAKN_BaldEagles].[dbo].[Summary_SurveyDatesByYear] where year = ",SurveyYear," Order By Year",sep = '')
DatesDF = GetDataFrameFromDatabase(Sql)

# Retrieve the annual summary information from the database
Sql = paste("  SELECT [Year]
, [Nests located]
, Occupied
, Successful
, NestsNotFound_P as [Not found]
, NestsNotCounted_P as [Not counted]
, [Young fledged]
, [% nest success]
, [Young/occupied nest]
, [Young/successful nest]
FROM Summary_SuccessByYear
ORDER BY [Year]")
SuccessByYearDF = GetDataFrameFromDatabase(Sql) # Get the data from the database into a data frame

# Filter on the current year and remove the Year column
CurrentSummaryDF = SuccessByYearDF[SuccessByYearDF$Year == SurveyYear,-1]


```

The Copper River in Wrangell-St. Elias National Park and Preserve (WRST) contains a high density of nesting Bald Eagles in interior Alaska; accordingly, the National Park Service identified Bald Eagles as a focal fauna species to monitor. Bald Eagles in WRST are a high profile species that are dependent upon many resources along the Copper River and are ecologically interesting because they nest at the northern edge of the species range. Bald Eagles are top-trophic level predators and they often respond quickly to changes in their environment by changing their breeding activities. In `r SurveyYear` we conducted an aerial bald eagle productivity survey in and around the park. Methods followed Putera J. and Miller S.D., 2018. Occupancy surveys were flown from `r GetLongDate(DatesDF$MinOccupancySurveyDate)` to `r GetLongDate(DatesDF$MaxOccupancySurveyDate)`, followed by productivity surveys from `r GetLongDate(DatesDF$MinProductivitySurveyDate)` to `r GetLongDate(DatesDF$MaxProductivitySurveyDate)`. We observed `r CurrentSummaryDF$'Nests located'` nests, of which `r CurrentSummaryDF$'Occupied'` were occupied (`r CurrentSummaryDF$'Occupied'/CurrentSummaryDF$'Nests located' * 100`%). Productivity surveys recorded `r CurrentSummaryDF$'Successful'` nests produced young (`r CurrentSummaryDF$'Successful'/CurrentSummaryDF$'Occupied' * 100`% of occupied nests). Successful nests resulted in `r CurrentSummaryDF$'Young fledged'` young, an average of `r CurrentSummaryDF$'Young/successful nest'` young per nest. `r CurrentSummaryDF$NestsNotFound_P` nests were not found., and `r CurrentSummaryDF$NestsNotCounted` were not counted.

# Introduction

The Copper River in WRST contains a high density of nesting Bald Eagles in interior Alaska; accordingly, the National Park Service identified Bald Eagles as a focal fauna species to monitor in Wrangell-St. Elias National Park and Preserve (WRST). Bald Eagles in WRST are a high profile species that are dependent upon many resources along the Copper River and are ecologically interesting because they nest at the northern edge of the species range. Bald Eagles are top-trophic level predators and they often respond quickly to changes in their environment by changing their breeding activities. Further, Bald Eagles nesting along the Copper River in WRST may face increasing disturbance due to forestry activities and increased human visitation.

Bald eagles (*Haliaeetus leucocephalus*) are common breeders in Wrangell-St Elias National Park and Preserve (WRST). Most nests are concentrated along the Copper River and its major tributaries. Potential threats to nesting eagles include habitat loss, human disturbance, and exposure to environmental contaminants that may affect reproduction or survival. Specific threats include highway construction from Chitina to Cordova, development and timber harvest on private lands along rivers, lakes, and coastal areas, potential increases in commercial and recreational fishing on the Copper River and its tributaries, camping or other recreational or subsistence access/use activities (including use of ATVs and jet boats) in sensitive breeding areas, and environmental contamination from local and global sources. Pollution is of special concern in the wake of the Exxon-Valdez oil spill that occurred near Valdez in March of 1989. The TransAlaska Pipeline crosses three tributaries of the Copper River---the Gulkana, Tazlina, and Klutina rivers. These rivers are also crossed by the Richardson Highway, which is heavily used by tanker trucks carrying petroleum products to and from the Valdez terminal. These are all important reasons to document long-term trends on population density and reproductive rates for bald eagles.

# Objectives

The objectives of the monitoring efforts are to:

-   Document the annual changes in occupancy of bald eagles,

-   Document the annual changes in productivity of bald eagle nests, and

-   Document any changes in distribution of bald eagle nests.

# Methods

## Study Area

Five survey areas were defined along major riverways, and are described in Kozie (1996):

1.) The Upper Copper River (UCR, 80km) extends from Copper and Tanada lakes to the confluence of the Chistochina River. White spruce (Picea glauca) is the predominant tree species, with balsam poplar (Populus balsamifera) common on the lower stretches. The Middle Copper River (MCR, 179km) extends from the Chistochina River south to the confluence of the Chitina River.

2.) The Middle Copper River (MCR) contains a mixture of both white spruce and balsam poplar, with poplar being slightly more common. The Copper River begins to braid along the MCR.

2.) The Lower Copper River (LCR) section (188km) extends from the Chitina River south to Miles Lake. The LCR is dominated by cottonwood along the river. The vegetation also begins to exhibit coastal influences, adding several coastal species including black cottonwood (Populus trichocarpa), Sitka spruce (Picea sitchensis), and mountain hemlock (Tsuga mertensiana). The Copper River is wide and more braided than the upper sections, with steep canyons on either side. Nesting begins consistently later along the LCR and is probably influenced by the numerous glaciers in the area which delay snow melt and maintain the area in a winter-like state several weeks after green up has begun to occur to the north.

3.) The Bremner River (45km) is surveyed from its confluence with the Copper River to the forks by Threemile Canyon, and has similar characteristics as the LCR.

4.) The Chitina River (116km) is surveyed from the confluence of the Copper River to where the river becomes braided above the Tana River. White spruce dominate the trees, with cottonwood becoming scarce in the upper reaches.

A total of 609 km of riverways are surveyed annually, amounting to over 1200km of surveys.

```{r echo=FALSE}

# Load shapefiles
Parks = read_sf("C:/Work/GIS Common Layers/GCS/AKParks_reprojected.shp")
Rivers = read_sf("C:/Work/GIS Common Layers/Alaska_Rivers_1M.shp")
AK  = read_sf("C:/Work/GIS Common Layers/GCS/AK_GCS_poly.shp")


ggplot() +
  
  # Blue rectangle to make the background of the map blue
  geom_rect(aes(xmin = -155,xmax = -140,ymin = 55,ymax = 70),fill = "steelblue3") +
  
  # Alaska outline
  geom_sf(data=AK,mapping=aes(), color='darkgray',fill='snow2') +
  
  # Park boundary
  geom_sf(data=Parks,mapping=aes(), color='yellow4',fill='yellow4',alpha=0.3) +
  
  # Rivers
  geom_sf(data=Rivers,mapping=aes(),color='steelblue3',fill='steelblue3') +
  
  # Set the map limits
  coord_sf(xlim = c(-146.6, -142), ylim = c(60.5, 62.8), expand = FALSE) +
  xlab('Longitude') +
  ylab('Latitude')+
  
  # Minimal theme
  theme_minimal() +
  
  # WRST Label
  geom_text(aes(x = -143.5, y = 61.8, label = "Wrangell - St. Elias 
National Park and Preserve"), size = 3, color = "black") +
  
  # Upper Copper River label
  geom_text(aes(x = -144, y = 62.45, label = "Upper Copper River"), size = 3, color = "dodgerblue4") +
  
  # Middle Copper River label
  geom_text(aes(x = -145.2, y = 61.5, label = "Middle Copper River"), size = 3, color = "dodgerblue4") +
  
  # Lower Copper River label
  geom_text(aes(x = -145.2, y = 60.8, label = "Lower Copper River"), size = 3, color = "dodgerblue4") +
  
  # Chitina River label
  geom_text(aes(x = -143.8, y = 61.25, label = "Chitina River"), size = 3, color = "dodgerblue4") +
  
  # Bremner River label
  geom_text(aes(x = -144, y = 60.9, label = "Bremner River"), size = 3, color = "dodgerblue4")
  



```

Figure `r FigureCounter`. Map of the bald eagles monitoring survey area in the Copper River drainage, Wrangell-St. Elias National Park and Preserve. Major tributaries in the survey area include the Chitina and Bremner rivers. `r FigureCounter = FigureCounter + 1`

## Surveys

Two aerial surveys were conducted---one to document territorial occupancy, and one to document productivity. Surveys were flown using a small airplane flying at low level (\<100m AGL) and low speed (\<100 kph), with one experienced observer. Flight paths followed the river's edge, with the opposite side covered on the return trip. In most cases, the relatively narrow riparian corridor allowed adequate coverage with a single pass on each side of the river. Where the corridor widened, multiple passes were made to adequately evaluate the available habitat.

For all new nests located, the following information was collected:

a)  Location (latitude/longitude via handheld Global Positioning System receiver),
b)  Count of adult birds,
c)  Behavior of adults (incubating, perched),
d)  Number of eggs observed,
e)  Number of nestlings,
f)  Species of nest tree (Populus spp., Picea spp.),
g)  Whether the nest tree was alive or dead, and
h)  Nest status (good, poor, remnant, gone).

All information except latitude/longitude was recorded on field forms. All nests still intact from the previous year's surveys were checked for occupancy during the occupancy survey. Information recorded for located nests include:

a)  Count of adult birds,
b)  Behavior of adults, and
c)  Number of eggs or nestlings observed.

During the second survey, all nest locations collected during prior surveys were checked for productivity. Territorial occupancy was defined based on a bird in the nest in incubating posture or two adult birds at a nest or in the nest tree (Postupalsky 1974). For the productivity survey, all nests observed with an incubating bird or two adult birds at a nest during the occupancy survey were checked to determine nest outcome. Multiple passes were commonly needed to count chicks, particularly in the Lower Copper area where cottonwoods are more common, and leaves make counting chicks difficult.

# Results

```{r echo=FALSE}

# Get the survey dates
Sql = paste("SELECT 
      --[Year],
      [MinOccupancySurveyDate] as [Occupancy survey start]
      ,[MaxOccupancySurveyDate] as [Occupancy survey end]
      -- ,[NumberOfOccupancySurveyDays]
      ,[MinProductivitySurveyDate] as [Productivity survey start]
      ,[MaxProductivitySurveyDate] as [Productivity survey end]
      -- ,[NumberOfProductivitySurveyDays]
  FROM [CAKN_BaldEagles].[dbo].[Summary_SurveyDatesByYear] 
  WHERE [Year] =",SurveyYear,sep="")

SurveyDatesDF = GetDataFrameFromDatabase(Sql) # Get the data from the database into a data frame
OStart = SurveyDatesDF$`Occupancy survey start`
OEnd = SurveyDatesDF$`Occupancy survey end`
PStart = SurveyDatesDF$`Productivity survey start`
PEnd = SurveyDatesDF$`Productivity survey end`
```

Bald eagle occupancy survey flights were conducted in WRST from `r GetLongDate(OStart)` to `r GetLongDate(OEnd)`. Follow-up productivity flights happened from `r GetLongDate(PStart)` to `r GetLongDate(PEnd)` (Table `r TableCounter`).

Table `r TableCounter`. Bald eagle survey flights, `r SurveyYear`.

```{r echo=FALSE}

# Output the survey dates
SurveyDatesDF_t = t(SurveyDatesDF)

# Change the goofy column header
colnames(SurveyDatesDF_t) = 'Date'

# Output the survey dates table
kable(SurveyDatesDF_t)

TableCounter = TableCounter + 1
```

## Survey results summary

Table `r TableCounter`. Results, `r SurveyYear` bald eagles survey.

```{r echo=FALSE, label="Summary (counts)"}

# Summarize the eagle counts from the CurrentSummaryDF data frame (way above) into 
# a table, transpose it so it fits the report better, modify the header, and output
# Because R stupidly adds decimal places to integer values when you transpose a table
# I've found the only way to correctly output the summary items is to separated out the
# integer columns into one transposed table, and decimal values to another.
# This is the integer table. Decimal metrics reported further down
SummaryCountsDF = CurrentSummaryDF[1:6] 
SummaryCountsDF_t = t(SummaryCountsDF) # Transpose the table so it fits better in the report
colnames(SummaryCountsDF_t)[1] = "Counts" # Change the wierd default first column name to something informative
kable(SummaryCountsDF_t)

# Increment the table counter
TableCounter = TableCounter + 1
```

Table `r TableCounter`. Metrics, `r SurveyYear` bald eagles survey.

```{r echo=FALSE, label="Summary (calculated metrics)"}

# Summarize the eagle counts from the CurrentSummaryDF data frame (way above) into 
# a table, transpose it so it fits the report better, modify the header, and output
# Because R stupidly adds decimal places to integer values when you transpose a table
# I've found the only way to correctly output the summary items is to separated out the
# integer columns into one transposed table, and decimal values to another.
# This is the decimal table. Integer counts reported above.
SummaryCalcsDF = CurrentSummaryDF[7:9] # Get just the integer summary items
SummaryCalcsDF_t = t(SummaryCalcsDF) # Transpose the table so it fits better in the report
colnames(SummaryCalcsDF_t)[1] = "Metrics" # Change the wierd default first column name to something informative
kable(SummaryCalcsDF_t)

# Increment the table counter
TableCounter = TableCounter + 1

```

## Survey results summary by river segment

Table `r TableCounter` shows nest success metrics by river segment for the `r SurveyYear` bald eagle survey in WRST. Nest succes, as defined as an eagle pair producing offspring observable during the late summer productivity survey, is shown in Figure `r FigureCounter`.

Table `r TableCounter`. Bald eagle productivity and success rates by river segment, `r SurveyYear`.

```{r echo=FALSE}
# Increment the table counter
TableCounter = TableCounter + 1

# Retrieve the annual summary information from the database
Sql = paste("SELECT 
      [Year],
      [RiverSegment] as [River segment]
      ,[NestsLocated] as [Nests located]
      ,[Occupied]
      ,[Unknown occupancy]
      ,[Successful]
      ,[Young fledged]
      ,[% nest success]
      ,[Young/occupied nest]
      ,[Young/successful nest]
  FROM [CAKN_BaldEagles].[dbo].[Summary_SuccessByYearAndRiverSegment]
  WHERE [Year] <= ",SurveyYear," ORDER BY RiverSegment,Year")

# Get the data from the database into a data frame
SuccessByYearRiverSegmentDF = GetDataFrameFromDatabase(Sql) 

# Filter the above data frame on the current year and omit the first (Year) column
CurrentSummaryDataFrame = SuccessByYearRiverSegmentDF[SuccessByYearRiverSegmentDF$Year == SurveyYear,2:10]

# Change all the values to strings so R does not pad zeroes to the integer values
CurrentSummaryDataFrame = sapply(CurrentSummaryDataFrame, as.character) 

# Transpose the data
SuccessByYearRiverSegmentDF_t = t(CurrentSummaryDataFrame)
colnames(SuccessByYearRiverSegmentDF_t)[1:5] = "" # Change the wierd first column with no name that R stuck in to Result

# Output the data
kable(SuccessByYearRiverSegmentDF_t)

```


```{r echo=FALSE}
# Increment the figure counter
FigureCounter = FigureCounter + 1

# Database query
Sql = paste("SELECT   
--Nest_ID
--, RiverSegment
[Lat-NAD83] AS Latitude
, [Lon-NAD83] AS Longitude
, NumYng
,CASE WHEN StatusCode_P = 'IF' THEN 'Failed' WHEN StatusCode_P = 'S' THEN 'Succeeded' ELSE NULL END AS Status
, StatusCode_P
--, Nest_O
FROM         Dataset_Productivity
WHERE     (Year = ",SurveyYear,") AND ([Lat-NAD83] IS NOT NULL) AND ([Lat-NAD83] > 50) AND (StatusCode_P IN ('S', 'IF'))
",sep='')

# Get data frame from query
ProductivityDataFrame = GetDataFrameFromDatabase(Sql)

# Map Title
title = paste("Dispersion of successful nests, ", SurveyYear)

# Query out just the successful nests
SuccessFulNestsDataFrame = subset(ProductivityDataFrame,StatusCode_P == 'S')

# Plot the nest success on a map
ggplot() +
  
  # Blue rectangle to make the background of the map blue
  geom_rect(aes(xmin = -155,xmax = -140,ymin = 55,ymax = 70),fill = "steelblue3") +
  
  # Alaska outline
  geom_sf(data=AK,mapping=aes(), color='darkgray',fill='snow2') +
  
  # Park boundary
  geom_sf(data=Parks,mapping=aes(), color='yellow4',fill='yellow4',alpha=0.3) +
  

  
  # Density kernel layer
  stat_density_2d(
  data=SuccessFulNestsDataFrame
  ,contour_var = "count"
  ,geom = "polygon"
  ,bins =  50
  ,alpha = 0.1 # Transparancy is high so the features underneath show
  ,aes(x = Longitude, y = Latitude, fill = ..level..)
  ,show.legend = FALSE) + # Don't show the density values in the legend
  guides(fill = guide_legend(title = "Density")) +
  scale_fill_distiller(palette = "Greens", direction = 1) + # Kernel density color, etc.

    # Rivers
  geom_sf(data=Rivers,mapping=aes(),color='steelblue3',fill='steelblue3') +  
  
  # Productive nests
  # Consider carefully whether to publish nest locations, or not
  geom_point(data=ProductivityDataFrame, aes(x = Longitude, y = Latitude,colour=Status)) +
  scale_color_manual(values = c("Succeeded" = "darkgreen", "Failed" = "red")) +
  
  # Set the map limits
  coord_sf(xlim = c(-146.6, -142), ylim = c(60.5, 62.8), expand = FALSE) +
  xlab('Longitude') +
  ylab('Latitude')+
  
  # Minimal theme
  theme_minimal() +
  
  # WRST Label
  geom_text(aes(x = -143.5, y = 61.8, label = "Wrangell - St. Elias 
National Park and Preserve"), size = 3, color = "black") +
  
    # Upper Copper River label
  geom_text(aes(x = -144, y = 62.45, label = "Upper Copper River"), size = 3, color = "dodgerblue4") +
  
  # Middle Copper River label
  geom_text(aes(x = -145.2, y = 61.5, label = "Middle Copper River"), size = 3, color = "dodgerblue4") +
  
  # Lower Copper River label
  geom_text(aes(x = -145.2, y = 60.8, label = "Lower Copper River"), size = 3, color = "dodgerblue4") +
  
  # Chitina River label
  geom_text(aes(x = -143.8, y = 61.25, label = "Chitina River"), size = 3, color = "dodgerblue4") +
  
  # Bremner River label
  geom_text(aes(x = -144, y = 60.9, label = "Bremner River"), size = 3, color = "dodgerblue4")



```

Figure `r FigureCounter`. Dispersion of successful bald eagle nests in the Copper River Valley in in `r SurveyYear`. Green areas show areas where nests were most successful at producing young.

```{r echo=FALSE}
#Increment the figure counter
FigureCounter = FigureCounter + 1

```

## Historical results

```{r echo=FALSE}

# Retrieve the annual summary information from the database
MeanSuccessRate = mean(SuccessByYearDF$`% nest success`)
MeanYoung = mean(SuccessByYearDF$`Young fledged`)
MeanYoungPerOccupiedNest = mean(SuccessByYearDF$`Young/occupied nest`)
MeanYoungPerSuccessfulNest = mean(SuccessByYearDF$`Young/successful nest`)
MeanSuccessByYear = mean(SuccessByYearDF$`% nest success`)
MinSuccessByYear = min(SuccessByYearDF$`% nest success`)
MaxSuccessByYear = max(SuccessByYearDF$`% nest success`)
MinYear = min(SuccessByYearDF$Year) 
MaxYear = max(SuccessByYearDF$Year)

TribsSuccessDF = subset(SuccessByYearRiverSegmentDF,SuccessByYearRiverSegmentDF$`River segment` != 'Chitina River Proper' & SuccessByYearRiverSegmentDF$`River segment` != 'Chitina River Tributaries')


```

Bald eagle monitoring has been done from 1989 through `r MaxYear` (Table 3). Mean nest success is `r MeanSuccessByYear`% ranging between `r MinSuccessByYear`% and `r MaxSuccessByYear`%.



Data from 1989-1996 is from Kozie, 1996.

```{r echo=FALSE}

# Linear model
SuccessByYearLM = lm(formula = `% nest success` ~ Year, data = SuccessByYearDF)

# Store the r squared, p and other statistics to show later
R2 = summary(SuccessByYearLM)$adj.r.squared
R2 = format(round(R2, 2), nsmall = 2)
p = summary(SuccessByYearLM)$coefficients["Year", "Pr(>|t|)"]
p=format(round(p, 2), nsmall = 2)
RegressionText = paste('R^2=',R2,' p=',p,sep='')

#Mean nest success
MeanNestSuccess = mean(SuccessByYearDF$`% nest success`)

# Plot nest success by year
# plot(SuccessByYearDF$Year,SuccessByYearDF$`% nest success`, type = "l",
#      main = "Nest success by year",
#      xlab = "Year",
#      ylab = "% success"
#      ,ylim=c(0,100)
#      )
# 
# # Plot fitted regression line
# abline(SuccessByYearLM)
# text(x = median(SuccessByYearDF$Year, na.rm = TRUE), y = max(SuccessByYearDF$`% nest success`), label = RegressionText)

# Output a summary of the linear model
# summary(SuccessByYearLM)

ggplot(data=SuccessByYearDF) +
  geom_line(mapping = aes(x=Year,y=`% nest success`)) +
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),method = "lm") +
   # Minimal theme
  theme_minimal() 

ggplot(data=TribsSuccessDF) +
  geom_line(mapping = aes(x=Year,y=`% nest success`)) +
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),method = "lm") +
   # Minimal theme
  theme_minimal() +
  facet_wrap(vars(`River segment`))


```

Figure `r FigureCounter`. Nest success by year: Entire study area (Mean nest success = `r MeanNestSuccess`, R\^2=`r R2`, p=`r p`).


```{r echo=FALSE}



# Linear model
# YoungPerOccNestLM <- lm(SuccessByYearDF$`Young/occupied nest` ~ SuccessByYearDF$Year)
# 
# # Store the r squared, p and other statistics to show later
# R2 = summary(YoungPerOccNestLM)$adj.r.squared
# R2 = format(round(R2, 2), nsmall = 2)
# p = summary(YoungPerOccNestLM)$coefficients["SuccessByYearDF$Year", "Pr(>|t|)"]
# p=format(round(p, 2), nsmall = 2)
# RegressionText = paste('R^2=',R2,' p=',p,sep='')
# 
# # Plot young per occupied nest by year
# # plot(SuccessByYearDF$Year,SuccessByYearDF$`Young/occupied nest`, type = "l",
# #      main = "Young per occupied nest by year",
# #      xlab = "Year",
# #      ylab = "Young per occupied nest")
# # #add fitted regression line
# # abline(YoungPerOccNestLM)
# # text(x = median(SuccessByYearDF$Year, na.rm = TRUE), y = max(SuccessByYearDF$`Young/occupied nest`), label = RegressionText)
# 
# # Print the regression summary
# #summary(YoungPerOccNestLM)
# 
# ggplot(data=SuccessByYearDF) +
#   geom_line(mapping = aes(x=Year,y=`Young/successful nest`)) +
#   geom_smooth(mapping = aes(x=Year,y=`Young/successful nest`),method = "lm") +
#    # Minimal theme
#   theme_minimal() 

```


### Young per successful nest

```{r echo=FALSE}
# Increment the figure counter
FigureCounter = FigureCounter + 1

lm <- lm(SuccessByYearDF$`Young/successful nest` ~ SuccessByYearDF$Year)
# Store the r squared, p and other statistics to show later
R2 = summary(lm)$adj.r.squared
R2 = format(round(R2, 2), nsmall = 2)
p = summary(lm)$coefficients["SuccessByYearDF$Year", "Pr(>|t|)"]
p=format(round(p, 2), nsmall = 2)
RegressionText = paste('R^2=',R2,' p=',p,sep='')

# Plot young per successful nest by year
# plot(SuccessByYearDF$Year,SuccessByYearDF$`Young/successful nest`, type = "l",
#      main = "Young per successful nest by year",
#      xlab = "Year",
#      ylab = "Young per successful nest"
#      ,ylim = c(0.5,3)
#      )
# 
# #add fitted regression line
# abline(lm)
# text(x = median(SuccessByYearDF$Year, na.rm = TRUE), y = max(SuccessByYearDF$`Young/successful nest`)* 1.1, label = RegressionText)
#summary(lm)

ggplot(data=SuccessByYearDF) +
  geom_line(mapping = aes(x=Year,y=`Young/successful nest`)) +
  geom_smooth(mapping = aes(x=Year,y=`Young/successful nest`),method = "lm") +
   # Minimal theme
  theme_minimal() 

ggplot(data=TribsSuccessDF) +
  geom_line(mapping = aes(x=Year,y=`Young/successful nest`)) +
  geom_smooth(mapping = aes(x=Year,y=`Young/successful nest`),method = "lm") +
   # Minimal theme
  theme_minimal() +
  facet_wrap(vars(`River segment`))

```

Figure `r FigureCounter`. Young per successful nest by year, entire study area.

### Long term productivity by river segment

```{r echo=FALSE}

ggplot(data=TribsSuccessDF) +
  geom_line(mapping = aes(x=Year,y=`% nest success`)) +
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),method = "lm") +
  facet_wrap(vars(`River segment`)) +
   # Minimal theme
  theme_minimal() 
```

Figure `r FigureCounter`. Long term nest success by year and river segment.



# Discussion

# Acknowledgements

# Literature cited

Kozie, 1996.

# Appendices

## Appendix A: Long-term productivity data

Table `r TableCounter`. Long term productivity over the Copper River watershed.

```{r echo=FALSE}
#Increment the table counter
TableCounter = TableCounter + 1

# Retrieve the annual summary information from the database
SuccessByYearDF_Char <- sapply(SuccessByYearDF, as.character)
SuccessByYearDF_Char[is.na(SuccessByYearDF)] <- " "
kable(SuccessByYearDF_Char)

```

Table `r TableCounter`. Long term productivity by river segment.

```{r echo=FALSE}
# Increment the counters
TableCounter = TableCounter + 1
FigureCounter = FigureCounter + 1

# Show the historical results by year and river segment
SuccessByYearRiverSegmentDF[ , c(1,2)]  <- SuccessByYearRiverSegmentDF[ , c(2,1)] # Swap the year, river segment columns
colnames(SuccessByYearRiverSegmentDF)[c(1,2)] <- colnames(SuccessByYearRiverSegmentDF)[c(2,1)]
kable(SuccessByYearRiverSegmentDF)
```

## Appendix B: Columns descriptions

[to be added]

```{r echo=FALSE}

# # Get the dates of the occupancy surveys
# Sql = paste("SELECT [Table],[Column]
#       ,[ColumnDescription]
#      
#   FROM [CAKN_BaldEagles].[dbo].[DatabaseColumnsDescriptions]
# where [Table] in ('Nests','SurveyData')
# order by [Table], [Column]",sep='')
# df = GetDataFrameFromDatabase(Sql)
# 
# # Output the table
# kable(df)
```
