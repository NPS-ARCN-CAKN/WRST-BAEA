---
output:
  html_document:
    number_sections: no
    toc: no
  
---


```{=html}
<style>
h1.title {
  font-family: "Times New Roman";
  font-size: 24px;
  font-weight: bold;
}

h1 {
    font-family: "Arial";
    font-size: 20px;
    font-weight: bold;
}


h2 {
  font-family: "Arial";
  font-size: 16px;
  font-weight: bold;
}

h3 {
  font-family: "Arial";
  font-size: 14px;
  font-weight: bold;
}

p {
    font-family: "Times New Roman";
    font-size: 12px;
}

.caption {
    font-family: "Arial";
    font-size: 10px;
}

p .caption {
    font-family: "Arial";
    font-size: 10px;
}

tr {
    font-family: "Arial";
    font-size: 10px;
}

.header{
  font-family: "Arial";
  font-size: 10px;
  font-weight: bold;
}

</style>
```

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) # Prevent overwhelming messages from reaching user

# Load libraries
library(RODBC)
library(knitr)
library(ggplot2)
library(sp)
library(sf)

# Make kable show blanks for NAs
options(knitr.kable.NA = '')

# These parameters restrict the dimensions of plots to 6 metric inches so they don't blow out Word
FigWidth = 6
```

```{r echo=FALSE,label="SET UP REPORT PARAMETERS HERE"}

# Set up report parameters here
SurveyYear = 2023  # Set this to the desired report year

# ODBC connection to the BAEA monitoring SQL Server Database. Set this up using 'ODBC Data Sources 64bit' on your computer.
# Contact data manager for server and database details.
# ConnectionString to the bald eagles Sql Server database
BaldEaglesConnectionString = "Driver=SQL Server Native Client 11.0;Server=inpyugamsvm01\\nuna;Database=CAKN_BaldEagles;trusted_connection=YES"

# Database connection to the eagles database
BaldEaglesConnection = odbcDriverConnect(connection = BaldEaglesConnectionString)

# Set the path to shapefiles used in the map, AK, Parks, Rivers, etc
ShpPath = "C:/Work/GIS Common Layers/"

```

---
title: Annual Report on Vital Signs monitoring of distribution and abundance of Bald Eagles in Wrangell-St. Elias National Park and Preserve, `r SurveyYear` 
output:
  html_document:
---

```{r echo=FALSE,label="Functions"}

# Current date
CurrentDate = Sys.Date() # Get the current date

# Function to return data frames from SQL database queries
GetDataFrameFromDatabase <- function(Sql) {
   return(sqlQuery(BaldEaglesConnection, Sql))
}

# Function to convert a date string to a long date
GetLongDate <- function(Date) {
  return(format(as.Date(Date), format="%B %d, %Y "))
}

# These counters are used to number the tables and figures. Each gets incremented after use.
TableCounter = 1
FigureCounter = 1

```


```{r echo=FALSE, label="Survey dates"}

# Gather data for the report


# Summary_SurveyDatesByYearDataFrame: Survey Dates
Sql = paste("SELECT 
--[Year],
[MinOccupancySurveyDate] as [Occupancy survey start]
,[MaxOccupancySurveyDate] as [Occupancy survey end]
-- ,[NumberOfOccupancySurveyDays]
,[MinProductivitySurveyDate] as [Productivity survey start]
,[MaxProductivitySurveyDate] as [Productivity survey end]
-- ,[NumberOfProductivitySurveyDays]
FROM [CAKN_BaldEagles].[dbo].[Summary_SurveyDatesByYear] 
WHERE [Year] = ",SurveyYear,sep="")
Summary_SurveyDatesByYearDataFrame = GetDataFrameFromDatabase(Sql) # Get the data from the database into a data frame

# Build some survey date values to use later in the markdown text
OStart = Summary_SurveyDatesByYearDataFrame$`Occupancy survey start`
OEnd = Summary_SurveyDatesByYearDataFrame$`Occupancy survey end`
PStart = Summary_SurveyDatesByYearDataFrame$`Productivity survey start`
PEnd = Summary_SurveyDatesByYearDataFrame$`Productivity survey end`

# Summary_SuccessByYear: Success and productivity data by year
Sql = paste("SELECT [Year]
,[Nests located]
,[Occupied]
,[Successful]
,[Productivity unknown]
--,[Eggs]
,[Young fledged]
,[% nest occupied]
,[% nest success]
,[Young/occupied nest]
,[Young/successful nest]
-- ,CASE WHEN Left(Source,3)='Fab' THEN 1 WHEN Left(Source,3)='Koz' THEN 2 WHEN Left(Source,3)='NPS' THEN 3 END as SourceCode
--,Source
FROM [Summary_SuccessByYear]
WHERE Year <= ",SurveyYear,"
ORDER BY [Year]",sep="")

# Get the data from the database into a data frame
Summary_SuccessByYearDataFrame = GetDataFrameFromDatabase(Sql) 

# We'll need just this year's data in a separated data frame from all the historical data.
# Filter on the summary data frame on the current year and then remove the Year column
Summary_SuccessByYearDataFrame_Current = Summary_SuccessByYearDataFrame[Summary_SuccessByYearDataFrame$Year == SurveyYear,-1]

# Build some summary statistics to report in the markdown
NestsLocated = Summary_SuccessByYearDataFrame_Current$`Nests located`
Occupied = Summary_SuccessByYearDataFrame_Current$Occupied
Successful = Summary_SuccessByYearDataFrame_Current$Successful
YoungFledged = Summary_SuccessByYearDataFrame_Current$`Young fledged`
NF = Summary_SuccessByYearDataFrame_Current$`Occupied nests not found during productivity survey)`
NC = Summary_SuccessByYearDataFrame_Current$`Occupied nests not counted during productivity survey)`
YngPerOccupiedNest = signif(Summary_SuccessByYearDataFrame_Current$`Young/occupied nest`,3)
YngPerSuccessfulNest = signif(Summary_SuccessByYearDataFrame_Current$`Young/successful nest`,3)
PctOccupied = signif(Summary_SuccessByYearDataFrame_Current$`% nest occupied`,2)
PctSuccessful = signif(Summary_SuccessByYearDataFrame_Current$`% nest success`,2)

ExecutiveSummaryText = paste("The Copper River in Wrangell-St. Elias National Park and Preserve (WRST), Alaska, contains a high density of nesting Bald Eagles <i>(Haliaeetus leucocephalus)</i> and the National Park Service has identified Bald Eagles as a focal fauna species to monitor. Bald Eagles in WRST are a high profile species that are dependent upon many resources along the Copper River and nest at the northern edge of the their range. Bald Eagles are top-trophic level predators and they often respond quickly to changes in their environment by changing their breeding activities. In ",SurveyYear," we conducted an aerial bald eagle productivity survey in and around the park. Nest occupancy surveys were flown from ",GetLongDate(OStart)," to ",GetLongDate(OEnd),", followed by productivity surveys from ",GetLongDate(PStart)," to ",GetLongDate(PEnd),". We observed ",NestsLocated," nests, of which ",Occupied," were occupied (",PctOccupied,"%). Productivity surveys revealed that ",Successful," occupied nests producing young (",PctSuccessful,"% of occupied nests). Successful nests resulted in ",YoungFledged," young, an average of ",YngPerSuccessfulNest," young per successful nest.",sep="")



```

Kyle Cutting^1^ and Scott Miller^2^

^1^National Park Service Wrangell St. Elias National Park and Preserve Copper Center, Alaska

^2^Arctic Inventory and Monitoring Network 240 W. 5th Ave Anchorage, Alaska 99501

`r CurrentDate`

U.S. Department of the Interior

National Park Service

Natural Resource Stewardship and Science

Fort Collins, Colorado




# Executive summary

`r ExecutiveSummaryText`

Key Words: Wrangell-St. Elias National Park and Preserve, Bald Eagle, *Haliaeetus leucocephalus*, Population dynamics, monitoring, `r SurveyYear`

# Introduction

The Copper River in WRST contains a high density of nesting Bald Eagles *(Haliaeetus leucocephalus)* in interior Alaska; accordingly, the National Park Service identified Bald Eagles as a focal fauna species to monitor in Wrangell-St. Elias National Park and Preserve (WRST). Bald Eagles in WRST are a high profile species that are dependent upon many resources along the Copper River and are ecologically interesting because they nest at the northern edge of the species range. Bald Eagles are top-trophic level predators and they often respond quickly to changes in their environment by changing their breeding activities. Further, Bald Eagles nesting along the Copper River in WRST may face increasing disturbance due to forestry activities and increased human visitation.

Bald eagles (*Haliaeetus leucocephalus*) are common breeders in Wrangell-St Elias National Park and Preserve (WRST). Most nests are concentrated along the Copper River and its major tributaries. Potential threats to nesting eagles include habitat loss, human disturbance, and exposure to environmental contaminants that may affect reproduction or survival. Specific threats include highway construction from Chitina to Cordova, development and timber harvest on private lands along rivers, lakes, and coastal areas, potential increases in commercial and recreational fishing on the Copper River and its tributaries, camping or other recreational or subsistence access/use activities (including use of ATVs and jet boats) in sensitive breeding areas, and environmental contamination from local and global sources. Pollution is of special concern in the wake of the Exxon-Valdez oil spill that occurred near Valdez in March of 1989. The TransAlaska Pipeline crosses three tributaries of the Copper River---the Gulkana, Tazlina, and Klutina rivers. These rivers are also crossed by the Richardson Highway, which is heavily used by tanker trucks carrying petroleum products to and from the Valdez terminal. These are all important reasons to document long-term trends on population density and reproductive rates for bald eagles.

# Objectives

The objectives of the monitoring efforts are to:

-   Document the annual changes in occupancy of bald eagles,

-   Document the annual changes in productivity of bald eagle nests, and

-   Document any changes in distribution of bald eagle nests.

# Methods

## Study Area

Five survey areas were defined along major riverways, and are described in Kozie (1996):

1.) The Upper Copper River (UCR, 80km) extends from Copper and Tanada lakes to the confluence of the Chistochina River. White spruce (Picea glauca) is the predominant tree species, with balsam poplar (Populus balsamifera) common on the lower stretches. The Middle Copper River (MCR, 179km) extends from the Chistochina River south to the confluence of the Chitina River.

2.) The Middle Copper River (MCR) contains a mixture of both white spruce and balsam poplar, with poplar being slightly more common. The Copper River begins to braid along the MCR.

2.) The Lower Copper River (LCR) section (188km) extends from the Chitina River south to Miles Lake. The LCR is dominated by cottonwood along the river. The vegetation also begins to exhibit coastal influences, adding several coastal species including black cottonwood (Populus trichocarpa), Sitka spruce (Picea sitchensis), and mountain hemlock (Tsuga mertensiana). The Copper River is wide and more braided than the upper sections, with steep canyons on either side. Nesting begins consistently later along the LCR and is probably influenced by the numerous glaciers in the area which delay snow melt and maintain the area in a winter-like state several weeks after green up has begun to occur to the north.

3.) The Bremner River (45km) is surveyed from its confluence with the Copper River to the forks by Threemile Canyon, and has similar characteristics as the LCR.

4.) The Chitina River (116km) is surveyed from the confluence of the Copper River to where the river becomes braided above the Tana River. White spruce dominate the trees, with cottonwood becoming scarce in the upper reaches.

A total of 609 km of riverways are surveyed annually, amounting to over 1200km of surveys.

```{r echo=FALSE,label="Survey area map",fig.alt=paste("Figure ",FigureCounter,". Map of the bald eagles monitoring survey area in the Copper River drainage, Wrangell-St. Elias National Park and Preserve. Major tributaries in the survey area include the Chitina and Bremner rivers.",sep=""),fig.cap=paste("Figure ",FigureCounter,". Map of the bald eagles monitoring survey area in the Copper River drainage, Wrangell-St. Elias National Park and Preserve. Major tributaries in the survey area include the Chitina and Bremner rivers.",sep=""),fig.width=FigWidth}

# Load shapefiles to be used in the maps later.
Parks = read_sf(paste(ShpPath,"GCS/AKParks_reprojected.shp",sep=""))
Rivers = read_sf(paste(ShpPath,"Alaska_Rivers_1M.shp",sep=""))
AK  = read_sf(paste(ShpPath,"GCS/AK_GCS_poly.shp",sep=""))

# Build a map of the survey area showing park boundaries, copper river and tributaries, etc.
ggplot() +
  
  # Blue rectangle to make the background of the map blue
  geom_rect(aes(xmin = -155,xmax = -140,ymin = 55,ymax = 70),fill = "steelblue3") +
  
  # Alaska outline
  geom_sf(data=AK,mapping=aes(), color='darkgray',fill='snow2') +
  
  # Park boundary
  geom_sf(data=Parks,mapping=aes(), color='yellow4',fill='yellow4',alpha=0.3) +
  
  # Rivers
  geom_sf(data=Rivers,mapping=aes(),color='steelblue3',fill='steelblue3') +
  
  # Set the map limits, zoom into the BAEA monitoring area
  coord_sf(xlim = c(-146.6, -142), ylim = c(60.5, 62.8), expand = FALSE) +
  xlab('Longitude') +
  ylab('Latitude')+
  
  # Minimal theme
  theme_minimal() +
  
  # WRST text Label
  geom_text(aes(x = -143.5, y = 61.8, label = "Wrangell - St. Elias National Park and Preserve"), size = 3, color = "black") +
  
  # Upper Copper River label
  geom_text(aes(x = -144, y = 62.45, label = "Upper Copper River"), size = 3, color = "dodgerblue4") +
  
  # Middle Copper River label
  geom_text(aes(x = -145.2, y = 61.5, label = "Middle Copper River"), size = 3, color = "dodgerblue4") +
  
  # Lower Copper River label
  geom_text(aes(x = -145.2, y = 60.8, label = "Lower Copper River"), size = 3, color = "dodgerblue4") +
  
  # Chitina River label
  geom_text(aes(x = -143.8, y = 61.25, label = "Chitina River"), size = 3, color = "dodgerblue4") +
  
  # Bremner River label
  geom_text(aes(x = -144, y = 60.9, label = "Bremner River"), size = 3, color = "dodgerblue4")

```



## Surveys

Two aerial surveys were conducted---one to document territorial occupancy, and one to document productivity. Surveys were flown using a small airplane flying at low level (\<100m AGL) and low speed (\<100 kph), with one experienced observer. Flight paths followed the river's edge, with the opposite side covered on the return trip. In most cases, the relatively narrow riparian corridor allowed adequate coverage with a single pass on each side of the river. Where the corridor widened, multiple passes were made to adequately evaluate the available habitat.

For all new nests located, the following information was collected:

a)  Location (latitude/longitude via handheld Global Positioning System receiver),
b)  Count of adult birds,
c)  Behavior of adults (incubating, perched),
d)  Number of eggs observed,
e)  Number of nestlings,
f)  Species of nest tree (Populus spp., Picea spp.),
g)  Whether the nest tree was alive or dead, and
h)  Nest status (good, poor, remnant, gone).

All information except latitude/longitude was recorded on field forms. All nests still intact from the previous year's surveys were checked for occupancy during the occupancy survey. Information recorded for located nests include:

a)  Count of adult birds,
b)  Behavior of adults, and
c)  Number of eggs or nestlings observed.

During the second survey, all nest locations collected during prior surveys were checked for productivity. Territorial occupancy was defined based on a bird in the nest in incubating posture or two adult birds at a nest or in the nest tree (Postupalsky 1974). For the productivity survey, all nests observed with an incubating bird or two adult birds at a nest during the occupancy survey were checked to determine nest outcome. Multiple passes were commonly needed to count chicks, particularly in the Lower Copper area where cottonwoods are more common, and leaves make counting chicks difficult.

# Results

```{r echo=FALSE,label="Get metrics into variables to use in markdown text"}

# Build a paragraph of information about the survey results into a variable. Embed this variable in the markdown text later (the stats could be embedded in the markdown individually, but for some reason it doesn't always work
#consistently, so I built the paragraph here.)
ResultsText = paste('Overall, ',NestsLocated, ' nests were located during the occupancy survey flights. Of these nests, ',Occupied,' were occupied (', PctOccupied,'%). and of occupied nests, ',Successful,' successfully produced young (',PctSuccessful,'%). Occupied nest production averaged ', YngPerOccupiedNest,' young per nest and successful nests produced a mean of ',YngPerSuccessfulNest,' young.',sep='')

```

Bald eagle occupancy survey flights were conducted in WRST from `r GetLongDate(OStart)` to `r GetLongDate(OEnd)`. Follow-up productivity flights happened from `r GetLongDate(PStart)` to `r GetLongDate(PEnd)`. `r ResultsText`

```{r echo=FALSE, label="Current survey metrics table"}
# Summarize the eagle counts for the current survey into 
# a table, transpose it so it fits the report better, modify the header, and output

# Convert it all to strings so R doesn't add decimal places to integers
Summary_SuccessByYearDataFrame_Current_char = sapply(Summary_SuccessByYearDataFrame_Current, as.character) 

# Convert it into a data frame
Summary_SuccessByYearDataFrame_Current_char_DF = as.data.frame(Summary_SuccessByYearDataFrame_Current_char)
colnames(Summary_SuccessByYearDataFrame_Current_char_DF) = 'Result'

#Output
kable(Summary_SuccessByYearDataFrame_Current_char_DF,col.names=c("Metric","Result"), caption=paste("Table ",TableCounter,". Results summary, ",SurveyYear," bald eagles survey.",sep=""))

# Increment the table counter
TableCounter = TableCounter + 1
```
```{r echo=FALSE, label="Success map",fig.alt=paste("Figure ",FigureCounter,". Dispersion of successful bald eagle nests in the Copper River Valley in in ",SurveyYear,". Green areas show areas where nests were most successful at producing young. Mean occupancy rate was ",Occupied,"% and mean success rate was ",Successful,"%.",sep=''),fig.cap=paste("Figure ",FigureCounter,". Dispersion of successful bald eagle nests in the Copper River Valley in in ",SurveyYear,". Green areas show areas where nests were most successful at producing young. Mean occupancy rate was ",PctOccupied,"% and mean success rate was ",PctSuccessful,"%.",sep=''),fig.width=FigWidth}

# Get the spatial locations of successful and failed nests for a map
Sql = paste("SELECT   
--Nest_ID
--, RiverSegment
[Lat-NAD83] AS Latitude
, [Lon-NAD83] AS Longitude
, NumYng
,CASE 
  WHEN StatusCode_P = 'IF' THEN 'Failed' 
  WHEN StatusCode_P = 'S' THEN 'Succeeded' 
  ELSE NULL 
END AS Status
, StatusCode_P
--, Nest_O
FROM Dataset_Productivity
WHERE (Year = ",SurveyYear,") 
AND ([Lat-NAD83] IS NOT NULL) -- Avoid missing spatial coords
AND ([Lat-NAD83] > 50) -- Avoid Lat/Lon records of 0/0
AND (StatusCode_P IN ('S', 'IF')) -- Successful or faild, ignore not found and not counted records
",sep='')

# Get data frame from query
Dataset_ProductivityDataFrame = GetDataFrameFromDatabase(Sql)
Dataset_ProductivityDataFrame[is.na(Dataset_ProductivityDataFrame)] = " "

# Map Title
title = paste("Dispersion of successful nests, ", SurveyYear)

# Query out just the successful nests
#SuccessFulNestsDataFrame = subset(Dataset_ProductivityDataFrame,StatusCode_P == 'S')

# Plot the nest success on a map
ggplot() +
  
  # Blue rectangle to make the background of the map blue
  geom_rect(aes(xmin = -155,xmax = -140,ymin = 55,ymax = 70),fill = "steelblue3") +
  
  # Alaska outline
  geom_sf(data=AK,mapping=aes(), color='darkgray',fill='snow2') +
  
  # Park boundary
  geom_sf(data=Parks,mapping=aes(), color='yellow4',fill='yellow4',alpha=0.3) +

    # Rivers
  geom_sf(data=Rivers,mapping=aes(),color='steelblue3',fill='steelblue3') +  
  
  # Productive nests
  # Consider carefully whether to publish nest locations, or not
  geom_point(data=Dataset_ProductivityDataFrame, aes(x = Longitude, y = Latitude,colour=Status,na.rm = TRUE,shape=Status),size=2) +
  scale_color_manual(values = c("Succeeded" = "black", "Failed" = "black")) +
  scale_shape_manual(values = c(4,19)) + # 4 = X, 19 = dot
  
  # Set the map limits
  coord_sf(xlim = c(-146.6, -142), ylim = c(60.5, 62.8), expand = FALSE) +
  xlab('Longitude') +
  ylab('Latitude')+
  
  # Minimal theme
  theme_minimal() +
  
  # WRST Label
  geom_text(aes(x = -143.5, y = 61.8, label = "Wrangell - St. Elias 
National Park and Preserve"), size = 3, color = "black") +
  
    # Upper Copper River label
  geom_text(aes(x = -144, y = 62.45, label = "Upper Copper River"), size = 3, color = "dodgerblue4") +
  
  # Middle Copper River label
  geom_text(aes(x = -145.2, y = 61.5, label = "Middle Copper River"), size = 3, color = "dodgerblue4") +
  
  # Lower Copper River label
  geom_text(aes(x = -145.2, y = 60.8, label = "Lower Copper River"), size = 3, color = "dodgerblue4") +
  
  # Chitina River label
  geom_text(aes(x = -143.8, y = 61.25, label = "Chitina River"), size = 3, color = "dodgerblue4") +
  
  # Bremner River label
  geom_text(aes(x = -144, y = 60.9, label = "Bremner River"), size = 3, color = "dodgerblue4")

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

```{r echo=FALSE,label="Productivity map",fig.alt=paste("Figure ",FigureCounter,". Productivity of successful bald eagle nests in the Copper River Valley in in ",SurveyYear,". Mean productivity of occupied nests was ",YngPerOccupiedNest," young per nest and mean productivity of successful nests was ",YngPerSuccessfulNest," young per nest.",sep=''),fig.cap=paste("Figure ",FigureCounter,". Productivity of successful bald eagle nests in the Copper River Valley in in ",SurveyYear,". Mean productivity of occupied nests was ",YngPerOccupiedNest," young per nest and mean productivity of successful nests was ",YngPerSuccessfulNest," young per nest.",sep=''),fig.width=FigWidth}

# Productivity map
ggplot() +
  
  # Blue rectangle to make the background of the map blue
  geom_rect(aes(xmin = -155,xmax = -140,ymin = 55,ymax = 70),fill = "steelblue3") +
  
  # Alaska outline
  geom_sf(data=AK,mapping=aes(), color='darkgray',fill='snow2') +
  
  # Park boundary
  geom_sf(data=Parks,mapping=aes(), color='yellow4',fill='yellow4',alpha=0.3) +

    # Rivers
  geom_sf(data=Rivers,mapping=aes(),color='steelblue3',fill='steelblue3') +  
  
  # Productive nests, increasing size with productivity
  geom_point(data=subset(Dataset_ProductivityDataFrame,Status=="Succeeded"), aes(x = Longitude, y = Latitude, colour=Status, size=factor(NumYng), na.rm = TRUE),color="black") +
  
  # Override the size attributes assigned by geom_point. 'values' is size of symbol.
  scale_size_manual(name="Young produced",values = c(2,5),breaks = c(1,2), labels = c("1","2")) +    
  
  # Set the map limits
  coord_sf(xlim = c(-146.6, -142), ylim = c(60.5, 62.8), expand = FALSE) +
  xlab('Longitude') +
  ylab('Latitude') +
  
  # Minimal theme
  theme_minimal() +
  
  # WRST Label
  geom_text(aes(x = -143.5, y = 61.8, label = "Wrangell - St. Elias 
National Park and Preserve"), size = 3, color = "black") +
  
    # Upper Copper River label
  geom_text(aes(x = -144, y = 62.45, label = "Upper Copper River"), size = 3, color = "dodgerblue4") +
  
  # Middle Copper River label
  geom_text(aes(x = -145.2, y = 61.5, label = "Middle Copper River"), size = 3, color = "dodgerblue4") +
  
  # Lower Copper River label
  geom_text(aes(x = -145.2, y = 60.8, label = "Lower Copper River"), size = 3, color = "dodgerblue4") +
  
  # Chitina River label
  geom_text(aes(x = -143.8, y = 61.25, label = "Chitina River"), size = 3, color = "dodgerblue4") +
  
  # Bremner River label
  geom_text(aes(x = -144, y = 60.9, label = "Bremner River"), size = 3, color = "dodgerblue4")

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

Table `r TableCounter` shows nest success metrics by river segment for the `r SurveyYear` bald eagle survey in WRST. Spatial distribution of surveyed nests and their productivity is shown in Figure `r FigureCounter`.

```{r echo=FALSE,label="Bald eagle productivity and success rates by river segment"}

# Retrieve the annual summary information from the database
Sql = paste("SELECT  [Year]
,[RiverSegment]
,[Nests located]
,[Occupied]
,[Successful]
,[Productivity unknown]
--,[Eggs] -- Eggs were inconsistently collected over the years
,[Young fledged]
,[% nest occupied]
,[% nest success]
,[Young/occupied nest]
,[Young/successful nest]
,[Occupied nests not found during productivity survey)]
,[Occupied nests not counted during productivity survey)]
FROM [CAKN_BaldEagles].[dbo].[Summary_SuccessByYearAndRiverSegment]
WHERE Year <= ",SurveyYear," 
And RiverSegment <> 'Chitina River Tributaries' -- only done once
And NOT(RiverSegment = 'Chitina' And Year = 1989) -- Only two nests observed, one successful, inflates chitina productivity so omit
ORDER BY Year DESC",sep="")

# Get the data from the database into a data frame
SuccessByYearRiverSegmentDF = GetDataFrameFromDatabase(Sql) 

# Filter the above data frame on the current year and omit the first (Year) column
CurrentSuccessByYearRiverSegmentDF = SuccessByYearRiverSegmentDF[SuccessByYearRiverSegmentDF$Year == SurveyYear,2:11]

# Change all the values to strings so R does not pad zeroes to the integer values
CurrentSuccessByYearRiverSegmentDF_str = sapply(CurrentSuccessByYearRiverSegmentDF, as.character) 

# Transpose the data
CurrentSuccessByYearRiverSegmentDF_str_t = t(CurrentSuccessByYearRiverSegmentDF_str)
colnames(CurrentSuccessByYearRiverSegmentDF_str_t)[1:5] = "" # Change the wierd first column with no name that R stuck in to Result

# Output the data
kable(CurrentSuccessByYearRiverSegmentDF_str_t, caption = paste("Table ",TableCounter,". Bald eagle productivity and success rates by river segment, ",SurveyYear,".",sep=""))

# Increment the table counter
TableCounter = TableCounter + 1
```

# Long term trends

```{r echo=FALSE,label="Build long term success and productivity metrics over the entire surveying history to use in the markdown"}

# Build long term success and productivity metrics over the entire surveying history to use in the markdown

# Length of record
MinYear = min(Summary_SuccessByYearDataFrame$Year, na.rm = TRUE) 
MaxYear = max(Summary_SuccessByYearDataFrame$Year, na.rm = TRUE)
LengthOfRecord = MaxYear - MinYear

# Occupancy rate %
MeanOccupancy = signif(round(mean(Summary_SuccessByYearDataFrame$`% nest occupied`, na.rm = TRUE),1),2)
MinOccupancy= signif(min(Summary_SuccessByYearDataFrame$`% nest occupied`, na.rm = TRUE),2)
MaxOccupancy= signif(max(Summary_SuccessByYearDataFrame$`% nest occupied`, na.rm = TRUE),2)

# Success rate %
MeanSuccess = signif(mean(Summary_SuccessByYearDataFrame$`% nest success`, na.rm = TRUE),2)
MinSuccess= signif(min(Summary_SuccessByYearDataFrame$`% nest success`, na.rm = TRUE),2)
MaxSuccess= signif(max(Summary_SuccessByYearDataFrame$`% nest success`, na.rm = TRUE),2)

# Productivity per nest
MeanYoungPerOccupiedNest = signif(mean(Summary_SuccessByYearDataFrame$`Young/occupied nest`, na.rm = TRUE),3)
MinYoungPerOccupiedNest = signif(min(Summary_SuccessByYearDataFrame$`Young/occupied nest`, na.rm = TRUE),3)
MaxYoungPerOccupiedNest = signif(max(Summary_SuccessByYearDataFrame$`Young/occupied nest`, na.rm = TRUE),3)
MeanYoungPerSuccessfulNest = signif(mean(Summary_SuccessByYearDataFrame$`Young/successful nest`, na.rm = TRUE),3)
MinYoungPerSuccessfulNest = signif(min(Summary_SuccessByYearDataFrame$`Young/successful nest`, na.rm = TRUE),3)
MaxYoungPerSuccessfulNest = signif(max(Summary_SuccessByYearDataFrame$`Young/successful nest`, na.rm = TRUE),3)

# Build a long term results summary paragraph to use in the markdown below
ResultsText = paste("Over the ",LengthOfRecord," year history of the bald eagles monitoring effort in the Copper River study area, mean nest occupancy has ranged from ", MinOccupancy,"% to ", MaxOccupancy,"%, averaging ",MeanOccupancy,"%. Success rates, defined as occupied nests producing young, has ranged from ",MinSuccess,"% to ",MaxSuccess,"%, averaging ",MeanSuccess,"%. Productivity averaged ",MeanYoungPerSuccessfulNest," young per successful nest, ranging between ",MinYoungPerSuccessfulNest," to ", MaxYoungPerSuccessfulNest,".",sep='')

```

`r ResultsText`

```{r echo=FALSE,label="Long-term bald eagle productivity metrics, Copper River Valley"}

# Show the long-term success and productivity metrics in a table
kable(Summary_SuccessByYearDataFrame, caption = paste("Table ",TableCounter,". Long-term bald eagle productivity metrics, Copper River Valley.",sep=""))

# Increment the table counter
TableCounter = TableCounter + 1

```

## Success

```{r echo = FALSE,label="Success rates plot prep"}
# This chunk generates a figure caption and alt text for the plot in the next R chunk. It has to be here in its own R chunk because it has to be ready to assign to the fig.alt and fig.cap attributes in the header of the next R chunk.

# Generate a linear model of success rate by year
lm = lm(formula = `% nest success` ~ Year, data = Summary_SuccessByYearDataFrame)

# Summarize the linear model
Summary = summary(lm)

# Extract linear model parameters from the Summary object. 
R2 = signif(Summary$adj.r.squared, 3)
AdjR2 = signif(Summary$adj.r.squared, 3)
P = signif(Summary$coef[2,4],5)
Intercept = signif(lm$coef[[1]],5 )
Slope = signif(lm$coef[[2]],5)

# Make a linear model text summary to put in the figure caption for the plot of success by year
lmStats_Success = paste("Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P)

# Generate a linear model of occupancy rate by year
lm = lm(formula = `% nest occupied` ~ Year, data = Summary_SuccessByYearDataFrame)

# Summarize the linear model
Summary = summary(lm)

# Extract linear model parameters from the Summary object. 
R2 = signif(Summary$adj.r.squared, 3)
AdjR2 = signif(Summary$adj.r.squared, 3)
P = signif(Summary$coef[2,4],5)
Intercept = signif(lm$coef[[1]],5 )
Slope = signif(lm$coef[[2]],5)

# Make a linear model text summary to put in the figure caption for the plot of success by year
lmStats_Occupancy = paste("Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P)

# Make a figure caption and alt text for the plot generated in the next R chunk
FigureCaption = paste("Figure ",FigureCounter,". Nest success by year over the Copper River study area. Dotted line shows mean nest occupancy rate (mean = ",MeanOccupancy,"%, ",lmStats_Occupancy,"). Dashed line shows mean success rate for all occupied nests (mean = ",MeanSuccess,"%, ",lmStats_Success,"). Occupancy data is not available prior to 2004. Full success and productivity metrics data are in the Appendix).",sep='')

```

```{r echo=FALSE,label="Percent nest success by year",fig.alt=FigureCaption,fig.cap=FigureCaption,fig.width=FigWidth}

# Plot historical occupancy and success rates for the whole watershed
ggplot(data=Summary_SuccessByYearDataFrame) +

  # % nest success linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # % nest success curve
  geom_line(mapping = aes(x=Year,y=`% nest success`,linetype='Percent of occupied nests that were successful')) +
  scale_linetype_manual(values = c("% nest success" = "solid")) +
  
  
  # % nest success linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`% nest occupied`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # % nest occupied curve
  geom_line(mapping = aes(x=Year,y=`% nest occupied`,linetype='Percent of nests that were occupied')) +

  # Fix the legend, define the line types
  scale_linetype_manual(name="",values = c("Percent of nests that were occupied" = "dotted","Percent of occupied nests that were successful" = "dashed"),) +
  
  # Label axes
  xlab("Year") +
  ylab("Success rate") +
  
  # Y limits
  ylim(0,100) +
  
   # Minimal theme
  theme_minimal() +
  theme(legend.position = "top") 
  

# Increment the figure counter
FigureCounter = FigureCounter + 1

```

## Productivity

```{r echo = FALSE,label="Productivity plot prep"}
# This chunk generates a figure caption and alt text for the plot in the next R chunk. It has to be here in its own R chunk because it has to be ready to assign to the fig.alt and fig.cap attributes in the header of the next R chunk.

# Generate a linear model of success rate by year
lm = lm(formula = `Young/successful nest` ~ Year, data = Summary_SuccessByYearDataFrame)

# Summarize the linear model
Summary = summary(lm)

# Extract linear model parameters from the Summary object. 
R2 = signif(Summary$adj.r.squared, 3)
AdjR2 = signif(Summary$adj.r.squared, 3)
P = signif(Summary$coef[2,4],5)
Intercept = signif(lm$coef[[1]],5 )
Slope = signif(lm$coef[[2]],5)

# Make a linear model text summary to put in the figure caption for the plot of success by year
lmStats_ProductivitySuccessful = paste("Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P)

# Generate a linear model of occupancy rate by year
lm = lm(formula = `Young/occupied nest` ~ Year, data = Summary_SuccessByYearDataFrame)

# Summarize the linear model
Summary = summary(lm)

# Extract linear model parameters from the Summary object. 
R2 = signif(Summary$adj.r.squared, 3)
AdjR2 = signif(Summary$adj.r.squared, 3)
P = signif(Summary$coef[2,4],5)
Intercept = signif(lm$coef[[1]],5 )
Slope = signif(lm$coef[[2]],5)

# Make a linear model text summary to put in the figure caption for the plot of success by year
lmStats_ProductivityOccupied = paste("Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P)

# Make a figure caption and alt text for the plot generated in the next R chunk
FigureCaption = paste("Figure ",FigureCounter,". Bald eagle productivity by year over the Copper River study area. Dashed line shows mean productivity for successful nests (occupied and productive) (mean = ",MeanYoungPerSuccessfulNest," young per nest, ",lmStats_ProductivitySuccessful,"). Dotted line shows mean productivity for all occupied nests (mean = ",MeanYoungPerOccupiedNest," young per nest, ",lmStats_ProductivityOccupied,"). Full success and productivity metrics data are in the Appendix).",sep='')

```

```{r echo=FALSE,label="Productivity by year plot",fig.alt=FigureCaption,fig.cap=FigureCaption,fig.width=FigWidth}

# Plot productivity
ggplot(data=Summary_SuccessByYearDataFrame) +
  
  # Young per successful nest linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`Young/successful nest`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # Young per successful nest mean horizontal line and label
  #geom_line(mapping = aes(x=Year,y=MeanYoungPerSuccessfulNest),linetype = "solid") +
  #geom_text(mapping = aes(x=2000,y=MeanYoungPerSuccessfulNest * 0.9),label=paste("Mean young/successful nest = ",MeanYoungPerSuccessfulNest,sep=""),linetype="solid") +

  # Young per successful nest curve
  geom_line(mapping = aes(x=Year,y=`Young/successful nest`,linetype='Young/successful nest')) +
  #scale_linetype_manual(values = c("Young/successful nest" = "solid")) +
  
  # Young per occupied nest linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`Young/occupied nest`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # Young per occupied nest mean horizontal line and label
  #geom_line(mapping = aes(x=Year,y=MeanYoungPerOccupiedNest),linetype = "solid") +
  #geom_text(mapping = aes(x=2000,y=MeanYoungPerOccupiedNest * 0.9),label=paste("Mean young/occupied nest = ",MeanYoungPerOccupiedNest,sep=""),linetype="dashed") +

  # Young per occupied nest curve
  geom_line(mapping = aes(x=Year,y=`Young/occupied nest`,linetype='Young/occupied nest')) +

  # Fix the legend, define the line types
  scale_linetype_manual(name="",values = c("Young/occupied nest" = "dotted","Young/successful nest" = "dashed"),) +
  
  # Label axes
  xlab("Year") +
  ylab("Young per nest") +
  
  # Y limits
  #ylim(1,2) +
  
   # Minimal theme
  theme_minimal() +
  theme(legend.position = "top")

# Increment the figure counter
FigureCounter = FigureCounter + 1

```



## Long term trends by river segment

Bald eagle monitoring has been done from `r MinYear` through `r MaxYear` (Appendix A). 


### Table of long term metrics by river segment

```{r echo = FALSE,label="Get results by river segment"}

# Get long term results by river segment into a data frame
Summary_SuccessByRiverSegmentDataFrame = GetDataFrameFromDatabase("SELECT 
RiverSegment
, Earliest
, Latest
, NumberOfSurveys as n
, NestsLocated as [Nests located]
, Occupied 
, Successful
, ProductivityUnknown [Productivity unknown]
, YoungProduced as [Total young produced]
, MeanYoungProduced as [Mean young produced]
, MeanYoungPerOccupiedNest as [Mean young per occupied nest]
, MeanYoungPerSuccessfulNest as  [Mean young per successful nest]
, MeanPctOccupied as [Mean occupancy rate (%)]
, MeanPctSuccess as [Mean success rate (%)]
FROM Summary_SuccessByRiverSegment
ORDER BY RiverSegment")

# Show the metrics for the river segment
t = t(Summary_SuccessByRiverSegmentDataFrame)
colnames(t) = c('','','','','')


# Make a caption for the table of long term metrics by river segment
TableCaption = paste("Table ",TableCounter,". Long term bald eagle nesting success and productivity metrics by river segment.",sep="")

kable(t,caption=TableCaption)

# Increment the table counter
TableCounter = TableCounter + 1

```

### Long term nest success by river segment

```{r echo=FALSE,label="Percent nest success by year by river segment",fig.alt=paste("Figure ",FigureCounter,". Nest success by year and river segment from , ",MinYear," - ",MaxYear," (full success and productivity metrics table is in Appendix).",sep=''),fig.cap=paste("Figure ",FigureCounter,". Nest success by year and river segment from , ",MinYear," - ",MaxYear," (full success and productivity metrics table is in Appendix).",sep=''),fig.width=FigWidth}

# plot % nest success faceted by river segment
ggplot(data=subset(SuccessByYearRiverSegmentDF,RiverSegment != "Copper River")) +
  geom_line(mapping = aes(x=Year,y=`% nest success`),color='black') +
  ylim(0,100) +
  
  
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),method = "lm",color='black') +
   # Minimal theme
  theme_minimal() +
  facet_wrap(vars(`RiverSegment`))

# Increment the figure counter
FigureCounter = FigureCounter + 1

```

Note: Faber (1989) reported 50% success rate on the Chitina River segment in 1989, but only two nests were observed in total. This result is omitted in the figure above.

### Long term productivity by river segment

```{r echo=FALSE,label="Productivity by year by river segment",fig.alt=paste("Figure ",FigureCounter,". Young per successful nest by year and river segment, ",MinYear," - ",MaxYear," (full success and productivity metrics table is in Appendix).",sep=''),fig.cap=paste("Figure ",FigureCounter,". Young per successful nest by year and river segment, ",MinYear," - ",MaxYear," (full success and productivity metrics table is in Appendix).",sep=''),fig.width=FigWidth}

# Plot productivity by year by river segment
ggplot(data=subset(SuccessByYearRiverSegmentDF,RiverSegment != "Copper River")) +
  geom_line(mapping = aes(x=Year,y=`Young/successful nest`)) +
  geom_smooth(mapping = aes(x=Year,y=`Young/successful nest`),method = "lm",color='black') +
  ylim(0,2) +
  
   # Minimal theme
  theme_minimal() +
  facet_wrap(vars(`RiverSegment`))

# Increment the figure counter
FigureCounter = FigureCounter + 1
```

```{r echo = FALSE}
# Function to do linear models on nest success and occupancy and return the results as text suitable for 
# a plot of the river segment's success over time
GetRiverSegmentSuccessPlotCaption = function(Segment, FigureNumber){
  
  # Isolate data for just the river segment specified by Segment
  RiverSegmentDF = subset(SuccessByYearRiverSegmentDF,`RiverSegment` == Segment)
  
  # Rates
  MetricsDF = subset(Summary_SuccessByRiverSegmentDataFrame,RiverSegment == Segment)
  MeanOccupancy = MetricsDF$`Mean occupancy rate (%)`
  MeanSuccess = MetricsDF$`Mean success rate (%)`
  n = MetricsDF$n
  
  # Generate a linear model of success rate by year
  lm = lm(formula = `Young/successful nest` ~ Year, data = RiverSegmentDF)
  
  # Summarize the linear model
  Summary = summary(lm)
  
  # Extract linear model parameters from the Summary object. 
  R2 = signif(Summary$adj.r.squared, 3)
  AdjR2 = signif(Summary$adj.r.squared, 3)
  P = signif(Summary$coef[2,4],5)
  Intercept = signif(lm$coef[[1]],5 )
  Slope = signif(lm$coef[[2]],5)
  
    # Make a linear model text summary to put in the figure caption for the plot of success by year
  lmStats_Success = paste("Mean success rate was ",MeanSuccess,"% (n = ",n,", Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P,")")
  
  # Generate a linear model of occupancy rate by year
  lm = lm(formula = `Young/occupied nest` ~ Year, data = RiverSegmentDF)
  
  # Summarize the linear model
  Summary = summary(lm)
  
  # Extract linear model parameters from the Summary object. 
  R2 = signif(Summary$adj.r.squared, 3)
  AdjR2 = signif(Summary$adj.r.squared, 3)
  P = signif(Summary$coef[2,4],5)
  Intercept = signif(lm$coef[[1]],5 )
  Slope = signif(lm$coef[[2]],5)

  # Make a linear model text summary to put in the figure caption for the plot of success by year
  lmStats_Occupancy = paste("Mean occupancy was ",MeanOccupancy,"% (n = ",n,", Adj R2 = ",AdjR2,", Intercept = ",Intercept, ", Slope =",Slope, ", P =",P,")")
  
  # Make a figure caption and alt text for the plot generated in the next R chunk
  FigureCaption = paste("Figure ",FigureNumber,". Nest occupancy and success rates on the ",Segment," river segment. ",lmStats_Occupancy,". ",lmStats_Success,".  Full success and productivity metrics data are in the Appendix).",sep='')
  
  # Return the figure caption
  return(FigureCaption)
}
```

```{r echo = FALSE}
# Function to do linear models on nest productivity and return the results as text suitable for 
# a plot of the river segment's success over time
GetRiverSegmentProductivityPlotCaption = function(Segment, FigureNumber){
  
    # Isolate data for just the river segment specified by Segment
  RiverSegmentDF = subset(SuccessByYearRiverSegmentDF,`RiverSegment` == Segment)
  
  # Rates
  MetricsDF = subset(Summary_SuccessByRiverSegmentDataFrame,RiverSegment == Segment)
  #MeanOccupancy = MetricsDF$`Mean occupancy rate (%)`
  #MeanSuccess = MetricsDF$`Mean success rate (%)`
  n = MetricsDF$n
  
  # Generate a linear model of success rate by year
  lm = lm(formula = `Young/successful nest` ~ Year, data = RiverSegmentDF)
  
  # Summarize the linear model
  Summary = summary(lm)
  
  # Extract linear model parameters from the Summary object. 
  R2 = signif(Summary$adj.r.squared, 3)
  AdjR2 = signif(Summary$adj.r.squared, 3)
  P = signif(Summary$coef[2,4],5)
  Intercept = signif(lm$coef[[1]],5 )
  Slope = signif(lm$coef[[2]],5)
  
    # Make a linear model text summary to put in the figure caption for the plot of success by year
  lmStats_Success = paste("Mean success rate was ",MeanSuccess,"% (n = ",n,", Adj R2 = ",AdjR2,"Intercept = ",Intercept, " Slope =",Slope, " P =",P,")")
  
  # Generate a linear model of occupancy rate by year
  lm = lm(formula = `Young/occupied nest` ~ Year, data = RiverSegmentDF)
  
  # Summarize the linear model
  Summary = summary(lm)
  
  # Extract linear model parameters from the Summary object. 
  R2 = signif(Summary$adj.r.squared, 3)
  AdjR2 = signif(Summary$adj.r.squared, 3)
  P = signif(Summary$coef[2,4],5)
  Intercept = signif(lm$coef[[1]],5 )
  Slope = signif(lm$coef[[2]],5)

  # Make a linear model text summary to put in the figure caption for the plot of success by year
  lmStats_Occupancy = paste("Mean occupancy was ",MeanOccupancy,"% (n = ",n,", Adj R2 = ",AdjR2,", Intercept = ",Intercept, ", Slope =",Slope, ", P =",P,")")
  
  # Make a figure caption and alt text for the plot generated in the next R chunk
  FigureCaption = paste("Figure ",FigureNumber,". Nest occupancy and success rates on the ",Segment," river segment. ",lmStats_Occupancy,". ",lmStats_Success,".  Full success and productivity metrics data are in the Appendix).",sep='')

  
  # Return the figure caption
  return(FigureCaption)
}
```

```{r echo = FALSE}
# Returns a nest occupancy and success plot for a river segment
GetRiverSegmentSuccessPlot = function(Segment){
  
  # Filter the summary data by the river segment
  DF = subset(SuccessByYearRiverSegmentDF,RiverSegment == Segment)

  # Plot % nest success faceted by river segment
  plot = ggplot(data=DF) +

  # % nest success linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`% nest success`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # % nest success curve
  geom_line(mapping = aes(x=Year,y=`% nest success`,linetype='Percent of occupied nests that were successful')) +
  scale_linetype_manual(values = c("% nest success" = "solid")) +
  
  # % nest occupancy linear regression model with 95% SE shaded area
  geom_smooth(mapping = aes(x=Year,y=`% nest occupied`),linetype="solid",color="black",method = "lm", se = TRUE, na.rm = FALSE,level = .95) +
  
  # % nest occupied curve
  geom_line(mapping = aes(x=Year,y=`% nest occupied`,linetype='Percent of nests that were occupied')) +

  # Fix the legend, define the line types
  scale_linetype_manual(name="",values = c("Percent of nests that were occupied" = "dotted","Percent of occupied nests that were successful" = "dashed"),) +
  
  # Label axes
  xlab("Year") +
  ylab(paste("Success rate, ",Segment,sep='')) +
  
  # Y limits
  ylim(0,100) +
  
   # Minimal theme
  theme_minimal() +
  theme(legend.position = "top") 
  
  return(plot)
}
```

```{r echo = FALSE}

# Show long term metrics for the river segment specified by RiverSegment
GetSummaryByRiverSegment = function(Segment){
  
  # Filter the Summary_SuccessByRiverSegmentDataFrame frame on RiverSegment
  Summary_SuccessByRiverSegmentDataFrame2 = subset(Summary_SuccessByRiverSegmentDataFrame,RiverSegment == Segment)
  
  # Truncate long decimal places to one decimal
  Summary_SuccessByRiverSegmentDataFrame2 =  data.frame(lapply(Summary_SuccessByRiverSegmentDataFrame2,  function(x) if(is.numeric(x)) round(x, 1) else x))

  # Knock off the RiverSegment column since it's already filtered on RiverSegment.
  Summary_SuccessByRiverSegmentDataFrame2$RiverSegment = NULL 
  
  # Convert it all to strings so R doesn't add decimal places to integers
  Summary_SuccessByRiverSegmentDataFrame2 = sapply(Summary_SuccessByRiverSegmentDataFrame2, as.character) 

  # Convert the above back into into a data frame
  Summary_SuccessByRiverSegmentDataFrame2 = as.data.frame(Summary_SuccessByRiverSegmentDataFrame2)

  # Blank out the uninformative first column
  colnames(Summary_SuccessByRiverSegmentDataFrame2) = ''
  
  return(Summary_SuccessByRiverSegmentDataFrame2)
}


```

### Lower Copper

```{r echo=FALSE}
# Present metrics by river segment 
Segment = "Lower Copper" # Specify the river segment to isolate

# Generate a figure caption for the plot that will be generated in the next R chunk
FigureCaption = GetRiverSegmentSuccessPlotCaption(Segment, FigureCounter)

```

```{r echo=FALSE,fig.alt=FigureCaption,fig.cap=FigureCaption, fig.width=FigWidth}

# Generate a plot of success for the river segment specified by Segment
GetRiverSegmentSuccessPlot(Segment)

# Increment the figure counter
FigureCounter = FigureCounter + 1

```


### Bremner

```{r echo=FALSE}
# Present metrics by river segment 
Segment = "Bremner" # Specify the river segment to isolate

# Generate a figure caption for the plot that will be generated in the next R chunk
FigureCaption = GetRiverSegmentSuccessPlotCaption(Segment, FigureCounter)

```

```{r echo=FALSE,fig.alt=FigureCaption,fig.cap=FigureCaption, fig.width=FigWidth}

# Generate a plot of success for the river segment specified by Segment
GetRiverSegmentSuccessPlot(Segment)

# Increment the figure counter
FigureCounter = FigureCounter + 1

```

### Chitina

```{r echo=FALSE}
# Present metrics by river segment 
Segment = "Chitina" # Specify the river segment to isolate

# Generate a figure caption for the plot that will be generated in the next R chunk
FigureCaption = GetRiverSegmentSuccessPlotCaption(Segment, FigureCounter)

```

```{r echo=FALSE,fig.alt=FigureCaption,fig.cap=FigureCaption, fig.width=FigWidth}

# Generate a plot of success for the river segment specified by Segment
GetRiverSegmentSuccessPlot(Segment)

# Increment the figure counter
FigureCounter = FigureCounter + 1

```


### Middle Copper

```{r echo=FALSE}
# Present metrics by river segment 
Segment = "Middle Copper" # Specify the river segment to isolate

# Generate a figure caption for the plot that will be generated in the next R chunk
FigureCaption = GetRiverSegmentSuccessPlotCaption(Segment, FigureCounter)

```

```{r echo=FALSE,fig.alt=FigureCaption,fig.cap=FigureCaption, fig.width=FigWidth}

# Generate a plot of success for the river segment specified by Segment
GetRiverSegmentSuccessPlot(Segment)

# Increment the figure counter
FigureCounter = FigureCounter + 1

```


### Upper Copper

```{r echo=FALSE}
# Present metrics by river segment 
Segment = "Upper Copper" # Specify the river segment to isolate

# Generate a figure caption for the plot that will be generated in the next R chunk
FigureCaption = GetRiverSegmentSuccessPlotCaption(Segment, FigureCounter)

```

```{r echo=FALSE,fig.alt=FigureCaption,fig.cap=FigureCaption, fig.width=FigWidth}

# Generate a plot of success for the river segment specified by Segment
GetRiverSegmentSuccessPlot(Segment)

# Increment the figure counter
FigureCounter = FigureCounter + 1

```


# Discussion

# Literature cited

Kozie, K. 1996. Bald Eagle Productivity for Wrangell-St Elias National Park and Preserve 1993-1996. Unpublished Report. National Park Service Wrangell St. Elias National Park. Copper Center, Alaska

Putera, J. and S.D. Miller. 2018. Protocol implementation plan for bald eagle monitoring in Wrangell-St. Elias National Park & Preserve, Central Alaska Network: Version 1.0. Natural Resource Report. NPS/CAKN/NRR2018/1752. National Park Service. Fort Collins, Colorado


## Appendix: Long-term productivity data

```{r echo=FALSE, label = "Appendix A: Long-term productivity data"}

# Long term productivity metrics
kable(SuccessByYearRiverSegmentDF, caption = paste("Table ",TableCounter,". Long term success and productivity metrics by year and river segment in the Copper River bald eagles monitoring study area.",sep=""))

# Increment the table counter
TableCounter = TableCounter + 1
```

Results prior to 2004 from Kozie (1996). Results including and after 2004 are from WRST and the NPS Central Alaska Inventory and Monitoring Program (Putera and Miller, 2018).

# Extended information about the survey

Information in this appendix is not intended for inclusion in the report; it's included to provide context to the survey for the authors to use or discard, as needed.

## Survey dates summary

```{r echo=FALSE, label = "Survey dates summary"}

# Transpose the survey dates data frame
Summary_SurveyDatesByYearDataFrame_t = t(Summary_SurveyDatesByYearDataFrame)

# Change the goofy column header
colnames(Summary_SurveyDatesByYearDataFrame_t) = 'Date'

# Output the survey dates table
kable(Summary_SurveyDatesByYearDataFrame_t)

```

